# Template Pipeline for Terraform Module Callers
# This pipeline is designed for repos that CALL/CONSUME Terraform modules
# NOT for the module repos themselves
env:
  # ====================
  # PROJECT CONFIGURATION
  # ====================
  PROJECT_NAME: "{{project_name}}"           # e.g., "app-infrastructure"
  SERVICE_NAME: "{{service_name}}"           # e.g., "api-gateway"
  
  # ====================
  # DEPLOYMENT CONFIGURATION
  # ====================
  TARGET_ENVIRONMENTS: "{{environments}}"    # e.g., "dev,stg,prd"
  REQUIRE_APPROVAL: "{{require_approval}}"   # true, false
  
  # ====================
  # SECURITY CONFIGURATION
  # ====================
  MIN_COMPLIANCE_SCORE: "{{compliance_score}}"  # e.g., "85"
  ENABLE_SECRET_SCANNING: "true"
  
  # ====================
  # NOTIFICATION CONFIGURATION
  # ====================
  WEBHOOK_URL: "{{webhook_url}}"             # e.g., "https://webhooks.company.com/hooks/terraform-alerts"
  NOTIFICATION_LEVEL: "all"                  # errors-only, deployments, all
  
  # ====================
  # INFRASTRUCTURE CONFIGURATION
  # ====================
  VAULT_NAMESPACE: "{{vault_namespace}}"     # e.g., "DevOps/prd/app-infrastructure"
  VAULT_ADDR: "{{vault_addr}}"               # e.g., "http://vault.gssira.com:8200"
  LYNX_BASE_URL: "{{lynx_url}}"              # e.g., "https://lynx.company.com"
  BACKUP_RETENTION_DAYS: "30"
  
  # ====================
  # MODULE CONFIGURATION
  # ====================
  # If your modules are in private registry/repos
  MODULE_REGISTRY_URL: "{{module_registry}}"  # e.g., "registry.terraform.io/yourorg"
  MODULE_VERSION_CONSTRAINT: "{{module_version}}"  # e.g., ">= 1.0.0, < 2.0.0"
  
  # ====================
  # HELPER SCRIPTS CONFIGURATION
  # ====================
  HELPER_SCRIPTS_REPO: "{{helper_scripts_repo}}"  # e.g., "git@github.com:yourorg/terraform-helper-scripts.git"
  HELPER_SCRIPTS_REF: "{{helper_scripts_ref}}"    # e.g., "main" or "v1.2.0"
  
  # ====================
  # FEATURE FLAGS
  # ====================
  ENABLE_AUTO_DOCUMENTATION: "true"
  ENABLE_SEMANTIC_VERSIONING: "false"
  VALIDATE_CONVENTIONAL_COMMITS: "false"

steps:
  # ============================================================================
  # PHASE 0: SETUP - CHECKOUT HELPER SCRIPTS
  # ============================================================================
  
  - label: ":git: Checkout Helper Scripts"
    key: "checkout-helpers"
    commands:
      - |
        if (Test-Path ".\\scripts") { Remove-Item -Recurse -Force ".\\scripts" }
        git clone --depth 1 --branch $env:HELPER_SCRIPTS_REF $env:HELPER_SCRIPTS_REPO .\\scripts
    agents:
      queue: "windows"

  # ============================================================================
  # PHASE 1: BUILD & VALIDATION
  # ============================================================================
  
  - group: "ðŸ“¦ Build & Validation Phase"
    key: "build-phase"
    depends_on: "checkout-helpers"
    steps:
      
      - label: ":hammer: Code Formatting Check"
        key: "format-check"
        command: "powershell -File .\\scripts\\Check-TerraformFormatting.ps1"
        agents:
          queue: "windows"

      - label: ":package: Validate Module Sources"
        key: "validate-modules"
        command: "powershell -File .\\scripts\\Validate-ModuleSources.ps1"
        agents:
          queue: "windows"

      - label: ":shield: Security Scanning"
        key: "security-scan"
        command: "powershell -File .\\scripts\\Run-SecurityScanning.ps1"
        artifact_paths:
          - "security-reports/**/*"
        agents:
          queue: "windows"

      - label: ":books: Generate Documentation"
        key: "generate-docs"
        command: "powershell -File .\\scripts\\Generate-TerraformDocs.ps1"
        artifact_paths:
          - "TERRAFORM.md"
          - "*/README.md"
        agents:
          queue: "windows"
        if: build.env("ENABLE_AUTO_DOCUMENTATION") == "true"

  # ============================================================================
  # PHASE 2: DYNAMIC PIPELINE GENERATION
  # ============================================================================
  
  - wait: ~
    continue_on_failure: false

  - label: ":pipeline: Generate Environment Pipelines"
    key: "generate-pipelines"
    depends_on: "build-phase"
    command: "powershell -File .\\scripts\\Generate-EnvironmentPipelines.ps1"
    agents:
      queue: "windows"
