# Template Pipeline for Terraform Module Callers
# This pipeline is designed for repos that CALL/CONSUME Terraform modules
# NOT for the module repos themselves
env:
  # ====================
  # PROJECT CONFIGURATION
  # ====================
  PROJECT_NAME: "{{project_name}}"           # e.g., "app-infrastructure"
  SERVICE_NAME: "{{service_name}}"           # e.g., "api-gateway"
  
  # ====================
  # DEPLOYMENT CONFIGURATION
  # ====================
  TARGET_ENVIRONMENTS: "{{environments}}"    # e.g., "dev,stg,prd"
  REQUIRE_APPROVAL: "{{require_approval}}"   # true, false
  
  # ====================
  # SECURITY CONFIGURATION
  # ====================
  MIN_COMPLIANCE_SCORE: "{{compliance_score}}"  # e.g., "85"
  ENABLE_SECRET_SCANNING: "true"
  
  # ====================
  # NOTIFICATION CONFIGURATION
  # ====================
  WEBHOOK_URL: "{{webhook_url}}"             # e.g., "https://webhooks.company.com/hooks/terraform-alerts"
  NOTIFICATION_LEVEL: "all"                  # errors-only, deployments, all
  
  # ====================
  # INFRASTRUCTURE CONFIGURATION
  # ====================
  VAULT_NAMESPACE: "{{vault_namespace}}"     # e.g., "DevOps/prd/app-infrastructure"
  VAULT_ADDR: "{{vault_addr}}"               # e.g., "http://vault.gssira.com:8200"
  VAULT_AUTH_PATH: "{{vault_auth_path}}"     # e.g., "jwt-buildkite" (the JWT auth mount path)
  VAULT_AUTH_ROLE: "{{vault_auth_role}}"     # e.g., "terraform-pipeline"
  LYNX_BASE_URL: "{{lynx_url}}"              # e.g., "https://lynx.company.com"
  BACKUP_RETENTION_DAYS: "30"
  
  # ====================
  # PROVIDER CONFIGURATION
  # ====================
  REQUIRED_PROVIDERS: "{{required_providers}}"  # e.g., "mondoo,netlify,aws,azure"
  
  # ====================
  # MODULE CONFIGURATION
  # ====================
  MODULE_REGISTRY_URL: "{{module_registry}}"  # e.g., "registry.terraform.io/yourorg"
  MODULE_VERSION_CONSTRAINT: "{{module_version}}"  # e.g., ">= 1.0.0, < 2.0.0"
  
  # ====================
  # HELPER SCRIPTS CONFIGURATION
  # ====================
  HELPER_SCRIPTS_REPO: "{{helper_scripts_repo}}"
  HELPER_SCRIPTS_REF: "{{helper_scripts_ref}}"
  
  # ====================
  # FEATURE FLAGS
  # ====================
  ENABLE_AUTO_DOCUMENTATION: "true"
  ENABLE_SEMANTIC_VERSIONING: "false"
  VALIDATE_CONVENTIONAL_COMMITS: "false"

steps:
  # ============================================================================
  # PHASE 0: SETUP
  # ============================================================================
  
  - group: "ðŸ”§ Setup Phase"
    key: "setup-phase"
    steps:
      
      - label: ":git: Checkout Helper Scripts"
        key: "checkout-helpers"
        commands:
          - |
            if (Test-Path ".\\scripts") { Remove-Item -Recurse -Force ".\\scripts" }
            git clone --depth 1 --branch $env:HELPER_SCRIPTS_REF $env:HELPER_SCRIPTS_REPO .\\scripts
        agents:
          queue: "windows"

      - label: ":vault: Fetch Secrets via OIDC"
        key: "fetch-secrets"
        commands:
          - |
            # Request OIDC token from Buildkite agent
            $oidcToken = buildkite-agent oidc request-token --audience "$env:VAULT_ADDR"
            
            # Authenticate to Vault using JWT auth method
            $authResponse = Invoke-RestMethod -Uri "$env:VAULT_ADDR/v1/auth/$env:VAULT_AUTH_PATH/login" `
              -Method POST `
              -ContentType "application/json" `
              -Body (@{ role = $env:VAULT_AUTH_ROLE; jwt = $oidcToken } | ConvertTo-Json)
            
            $vaultToken = $authResponse.auth.client_token
            $headers = @{ "X-Vault-Token" = $vaultToken }
            
            # Create secrets directory
            New-Item -ItemType Directory -Force -Path ".\\secrets\\providers" | Out-Null
            
            # Fetch Lynx credentials
            $lynxSecrets = Invoke-RestMethod -Uri "$env:VAULT_ADDR/v1/$env:VAULT_NAMESPACE/data/lynx" `
              -Headers $headers
            $lynxSecrets.data.data | ConvertTo-Json | Out-File ".\\secrets\\lynx.json"
            
            # Fetch provider credentials
            $providers = $env:REQUIRED_PROVIDERS -split ","
            foreach ($provider in $providers) {
              $provider = $provider.Trim()
              try {
                $secrets = Invoke-RestMethod -Uri "$env:VAULT_ADDR/v1/$env:VAULT_NAMESPACE/data/providers/$provider" `
                  -Headers $headers
                $secrets.data.data | ConvertTo-Json | Out-File ".\\secrets\\providers\\$provider.json"
                Write-Host "âœ… Fetched secrets for $provider"
              } catch {
                Write-Warning "âš ï¸ No secrets found for $provider"
              }
            }
        artifact_paths:
          - ".secrets/**/*"
        agents:
          queue: "windows"
        depends_on: "checkout-helpers"

  # ============================================================================
  # PHASE 1: BUILD & VALIDATION
  # ============================================================================
  
  - group: "ðŸ“¦ Build & Validation Phase"
    key: "build-phase"
    depends_on: "setup-phase"
    steps:
      
      - label: ":hammer: Code Formatting Check"
        key: "format-check"
        command: "powershell -File .\\scripts\\Check-TerraformFormatting.ps1"
        agents:
          queue: "windows"

      - label: ":package: Validate Module Sources"
        key: "validate-modules"
        command: "powershell -File .\\scripts\\Validate-ModuleSources.ps1"
        agents:
          queue: "windows"

      - label: ":shield: Security Scanning"
        key: "security-scan"
        commands:
          - buildkite-agent artifact download ".secrets/**/*" .
          - |
            powershell -File .\\scripts\\Run-SecurityScanning.ps1 `
              -MondooCredsFile ".\\secrets\\providers\\mondoo.json"
        artifact_paths:
          - "security-reports/**/*"
        agents:
          queue: "windows"

      - label: ":books: Generate Documentation"
        key: "generate-docs"
        command: "powershell -File .\\scripts\\Generate-TerraformDocs.ps1"
        artifact_paths:
          - "TERRAFORM.md"
          - "*/README.md"
        agents:
          queue: "windows"
        if: build.env("ENABLE_AUTO_DOCUMENTATION") == "true"

  # ============================================================================
  # PHASE 2: DYNAMIC PIPELINE GENERATION
  # ============================================================================
  
  - wait: ~
    continue_on_failure: false

  - label: ":pipeline: Generate Environment Pipelines"
    key: "generate-pipelines"
    depends_on: "build-phase"
    commands:
      - buildkite-agent artifact download ".secrets/**/*" .
      - |
        powershell -File .\\scripts\\Generate-EnvironmentPipelines.ps1 `
          -LynxCredsFile ".\\secrets\\lynx.json" `
          -ProviderSecretsDir ".\\secrets\\providers"
    agents:
      queue: "windows"
