# terraform-service.yml
# Full pipeline for Terraform services (that use modules)
# Lives in central scripts repo, called via bootstrap

# These can be overridden by the calling repo's bootstrap
env:
  # Lynx configuration
  LYNX_SERVER_URL: "${LYNX_SERVER_URL:-https://lynx.yourcompany.com}"
  LYNX_TEAM: "${LYNX_TEAM:-platform}"
  LYNX_PROJECT: "${LYNX_PROJECT:-unnamed}"
  
  # Environments (can be overridden)
  ENVIRONMENTS: "${ENVIRONMENTS:-dev tst prd}"
  
  # Vault configuration
  VAULT_ADDR: "${VAULT_ADDR:-https://vault.yourcompany.com}"
  
  # Terraform settings
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"
  
  # Scripts path (set by bootstrap)
  SCRIPTS_PATH: ".buildkite-scripts/scripts"

steps:
  # ============================================
  # PHASE 1: VALIDATION (Global, runs once)
  # ============================================
  
  - label: ":terraform: Validate & Format"
    key: "validate"
    commands:
      - "pwsh -File $$SCRIPTS_PATH/terraform-validate.ps1"
    agents:
      queue: "terraform"

  - label: ":shield: Security Scans"
    key: "security-scan"
    depends_on: "validate"
    commands:
      - "pwsh -File $$SCRIPTS_PATH/run-security-scans.ps1"
    agents:
      queue: "terraform"

  # ============================================
  # PHASE 2: DYNAMIC ENVIRONMENT STEPS
  # ============================================
  
  - label: ":pipeline: Generate Environment Steps"
    key: "generate"
    depends_on: "security-scan"
    commands:
      - "pwsh -File $$SCRIPTS_PATH/generate-env-steps.ps1"
    agents:
      queue: "terraform"
